!function(){"use strict";const e="securent-fb-cache",t="securent-fb-cache-time";function n(n){try{localStorage.setItem(e,JSON.stringify(n)),localStorage.setItem(t,(new Date).toISOString())}catch(e){console.warn("Failed to save to cache:",e)}}function s(){try{const n=localStorage.getItem(e),s=localStorage.getItem(t);if(n&&s)return{data:JSON.parse(n),timestamp:new Date(s)}}catch(e){console.warn("Failed to read from cache:",e)}return null}async function r(e){try{const t=await async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;const s=[1e3,2e3];for(let r=0;r<=t;r++)try{const t=new AbortController,s=setTimeout(()=>t.abort(),5e3),r=await fetch(e,{signal:t.signal,method:"GET",headers:{Accept:"application/json"}});if(clearTimeout(s),!r.ok){if(r.status>=400&&r.status<500)throw new Error(`API error: ${r.status}`);throw new Error(`HTTP ${r.status}`)}const a=await r.json();return n(a),a}catch(e){if(r===t)throw console.error("API fetch failed after retries:",e),e;r<s.length&&await new Promise(e=>setTimeout(e,s[r]))}}(e);return{data:t,fromCache:!1,timestamp:new Date}}catch(e){const t=s();if(t)return{data:t.data,fromCache:!0,timestamp:t.timestamp,error:e.message};throw e}}function a(e){return`\n    <div class="securent-fb-cache-notice" role="alert">\n      <svg class="securent-fb-icon-warning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>\n        <line x1="12" y1="9" x2="12" y2="13"></line>\n        <line x1="12" y1="17" x2="12.01" y2="17"></line>\n      </svg>\n      <span>Showing posts from ${function(e){const t=new Date-e,n=Math.floor(t/6e4),s=Math.floor(t/36e5),r=Math.floor(t/864e5);if(n<1)return"just now";if(n<60)return`${n} minute${1!==n?"s":""} ago`;if(s<24)return`${s} hour${1!==s?"s":""} ago`;if(r<7)return`${r} day${1!==r?"s":""} ago`;const a=String(e.getDate()).padStart(2,"0"),i=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear(),l=String(e.getHours()).padStart(2,"0"),c=String(e.getMinutes()).padStart(2,"0");return`${a}/${i}/${o} ${l}:${c}`}(e)}. Unable to load latest updates.</span>\n    </div>\n  `}class i{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.element=e,this.options={apiUrl:t.apiUrl||"https://securent.nt.gov.au/_design/integration-points/socials/facebook-securent/_nocache",itemsPerPage:parseInt(t.itemsPerPage)||5,fallbackUrl:t.fallbackUrl||"https://www.facebook.com/SecureNT",theme:t.theme||"light",title:t.title||"Latest from SecureNT",content:t.content||null,fallbackMessage:t.fallbackMessage||null},this.filterKeywords=t.filterKeywords?t.filterKeywords.split(";").map(e=>e.trim().toLowerCase()).filter(e=>e):null,this.startDate=t.startDate?new Date(t.startDate):null,this.endDate=t.endDate?new Date(t.endDate):null,this.posts=[],this.currentPage=1,this.isLoading=!1,this.observer=null,this.fromCache=!1,this.cacheTimestamp=null,this.init()}init(){this.element.classList.add("securent-fb-widget"),this.element.classList.add(`securent-fb-theme-${this.options.theme}`),this.setupLazyLoading()}setupLazyLoading(){this.observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&!this.isLoading&&0===this.posts.length&&(this.loadFeed(),this.observer.unobserve(this.element))})},{rootMargin:"50px",threshold:.1}),this.observer.observe(this.element)}async loadFeed(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.isLoading){this.isLoading=!0,e?this.showLoadingState():this.showSkeletonLoader();try{const e=await r(this.options.apiUrl);this.posts=this.filterPosts(e.data),this.fromCache=e.fromCache,this.cacheTimestamp=e.timestamp,this.currentPage=1,this.render()}catch(e){this.showError()}finally{this.isLoading=!1}}}showSkeletonLoader(){const e=Array(this.options.itemsPerPage).fill(0).map(()=>'\n      <div class="securent-fb-post securent-fb-skeleton">\n        <div class="securent-fb-skeleton-header"></div>\n        <div class="securent-fb-skeleton-text"></div>\n        <div class="securent-fb-skeleton-text"></div>\n        <div class="securent-fb-skeleton-text short"></div>\n      </div>\n    ').join("");this.element.innerHTML=`<div class="securent-fb-feed">${e}</div>`}showLoadingState(){const e=this.element.querySelector(".securent-fb-loading");e&&(e.style.display="flex")}filterPosts(e){return e&&0!==e.length?e.filter(e=>{if(this.startDate||this.endDate){const t=new Date(e.created_time);if(this.startDate&&t<this.startDate)return!1;if(this.endDate){const e=new Date(this.endDate);if(e.setHours(23,59,59,999),t>e)return!1}}if(this.filterKeywords&&this.filterKeywords.length>0){const t=(e.message||"").toLowerCase();if(!this.filterKeywords.some(e=>t.includes(e)))return!1}return!0}):[]}showError(){const e=s();if(e)this.posts=this.filterPosts(e.data),this.fromCache=!0,this.cacheTimestamp=e.timestamp,this.currentPage=1,this.render();else{const e=this.options.fallbackMessage||"Unable to load posts at this time.";this.element.innerHTML=`\n        <div class="securent-fb-error">\n          <p>${this.escapeHtml(e)}</p>\n          <p><a href="${this.options.fallbackUrl}" target="_blank" rel="noopener noreferrer">Visit SecureNT on Facebook</a></p>\n        </div>\n      `}}render(){const e=(this.currentPage-1)*this.options.itemsPerPage,t=e+this.options.itemsPerPage,n=this.posts.slice(e,t),s=Math.ceil(this.posts.length/this.options.itemsPerPage);let r="";this.fromCache&&(r+=a(this.cacheTimestamp)),r+=this.renderHeader(),r+='<div class="securent-fb-feed">',n.forEach(e=>{r+=this.renderPost(e)}),r+="</div>",s>1&&(r+=this.renderPagination(s)),this.element.innerHTML=r,this.attachEventListeners()}renderHeader(){const e=this.options.content?`<div class="securent-fb-header-content">${this.options.content}</div>`:"";return`\n      <div class="securent-fb-header">\n        <div class="securent-fb-header-top">\n          <h2>${this.escapeHtml(this.options.title)}</h2>\n          <button class="securent-fb-refresh" aria-label="Refresh posts" title="Refresh posts">\n            <svg class="securent-fb-icon-refresh" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <polyline points="23 4 23 10 17 10"></polyline>\n              <polyline points="1 20 1 14 7 14"></polyline>\n              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>\n            </svg>\n            Refresh\n          </button>\n        </div>\n        ${e}\n      </div>\n      <div class="securent-fb-loading" style="display: none;">\n        <div class="securent-fb-spinner"></div>\n        <span>Refreshing...</span>\n      </div>\n    `}renderPost(e){const t=new Date(e.created_time),n=this.getRelativeTime(t),s=this.formatAbsoluteTime(t),r=this.formatMessage(e.message||""),a=e.attachments?this.renderAttachments(e.attachments.data):"";return`\n      <article class="securent-fb-post">\n        <time class="securent-fb-timestamp" datetime="${e.created_time}" title="${s}">\n          ${n}\n        </time>\n        <div class="securent-fb-message">${r}</div>\n        ${a}\n      </article>\n    `}formatMessage(e){let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return t=t.replace(/(https?:\/\/[^\s<]+)/g,e=>`<a href="${e}" target="_blank" rel="noopener noreferrer" class="securent-fb-link">${e}</a>`),t=t.replace(/\n/g,"<br>"),t}renderAttachments(e){if(!e||0===e.length)return"";const t=e.map(e=>e.unshimmed_url&&e.title?`\n          <a href="${this.escapeHtml(e.unshimmed_url)}" \n             class="securent-fb-attachment" \n             target="_blank" \n             rel="noopener noreferrer">\n            ${this.escapeHtml(e.title)}\n            <svg class="securent-fb-icon-external" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n              <polyline points="15 3 21 3 21 9"></polyline>\n              <line x1="10" y1="14" x2="21" y2="3"></line>\n            </svg>\n          </a>\n        `:"").filter(e=>e).join("");return t?`<div class="securent-fb-attachments">${t}</div>`:""}renderPagination(e){const t=1===this.currentPage,n=this.currentPage===e;return`\n      <div class="securent-fb-pagination">\n        <button class="securent-fb-btn-pagination securent-fb-btn-prev" \n                ${t?"disabled":""} \n                aria-label="Previous page">\n          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="15 18 9 12 15 6"></polyline>\n          </svg>\n          Previous\n        </button>\n        <span class="securent-fb-page-info" aria-live="polite">\n          Page ${this.currentPage} of ${e}\n        </span>\n        <button class="securent-fb-btn-pagination securent-fb-btn-next" \n                ${n?"disabled":""} \n                aria-label="Next page">\n          Next\n          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="9 18 15 12 9 6"></polyline>\n          </svg>\n        </button>\n      </div>\n    `}getRelativeTime(e){const t=new Date-e,n=Math.floor(t/6e4),s=Math.floor(t/36e5),r=Math.floor(t/864e5);return n<1?"just now":n<60?`${n} minute${1!==n?"s":""} ago`:s<24?`${s} hour${1!==s?"s":""} ago`:r<7?`${r} day${1!==r?"s":""} ago`:this.formatShortDate(e)}formatAbsoluteTime(e){return`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}/${e.getFullYear()} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}formatShortDate(e){return`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}/${e.getFullYear()}`}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}attachEventListeners(){const e=this.element.querySelector(".securent-fb-refresh");e&&e.addEventListener("click",()=>this.loadFeed(!0));const t=this.element.querySelector(".securent-fb-btn-prev"),n=this.element.querySelector(".securent-fb-btn-next");t&&t.addEventListener("click",()=>this.goToPage(this.currentPage-1)),n&&n.addEventListener("click",()=>this.goToPage(this.currentPage+1))}goToPage(e){const t=Math.ceil(this.posts.length/this.options.itemsPerPage);e<1||e>t||(this.currentPage=e,this.render(),this.element.scrollIntoView({behavior:"smooth",block:"start"}))}destroy(){this.observer&&this.observer.disconnect(),this.element.innerHTML=""}}!function(e){function t(){document.querySelectorAll("[data-securent-fb-widget]").forEach(e=>{if(e.hasAttribute("data-securent-fb-initialized"))return;const t={apiUrl:e.getAttribute("data-api-url"),itemsPerPage:e.getAttribute("data-items-per-page"),fallbackUrl:e.getAttribute("data-fallback-url"),theme:e.getAttribute("data-theme"),title:e.getAttribute("data-title"),content:e.getAttribute("data-content"),filterKeywords:e.getAttribute("data-filter-keywords"),startDate:e.getAttribute("data-start-date"),endDate:e.getAttribute("data-end-date"),fallbackMessage:e.getAttribute("data-fallback-message")};Object.keys(t).forEach(e=>{null!==t[e]&&void 0!==t[e]||delete t[e]});const n=new i(e,t);e.setAttribute("data-securent-fb-initialized","true"),e._securentFbWidget=n})}const n={init:t,create:function(e){return new i(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})},getInstance:function(e){return e._securentFbWidget||null},version:"1.0.0"};e.SecureNTFacebookWidget=n,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}(window)}();
