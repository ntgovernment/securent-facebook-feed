!function(){"use strict";const t="securent-fb-cache",e="securent-fb-cache-time";function n(n){try{localStorage.setItem(t,JSON.stringify(n)),localStorage.setItem(e,(new Date).toISOString())}catch(t){console.warn("Failed to save to cache:",t)}}function s(){try{const n=localStorage.getItem(t),s=localStorage.getItem(e);if(n&&s)return{data:JSON.parse(n),timestamp:new Date(s)}}catch(t){console.warn("Failed to read from cache:",t)}return null}async function r(t){try{const e=await async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;const s=[1e3,2e3];for(let r=0;r<=e;r++)try{const e=new AbortController,s=setTimeout(()=>e.abort(),5e3),r=await fetch(t,{signal:e.signal,method:"GET",headers:{Accept:"application/json"}});if(clearTimeout(s),!r.ok){if(r.status>=400&&r.status<500)throw new Error(`API error: ${r.status}`);throw new Error(`HTTP ${r.status}`)}const i=await r.json();return n(i),i}catch(t){if(r===e)throw console.error("API fetch failed after retries:",t),t;r<s.length&&await new Promise(t=>setTimeout(t,s[r]))}}(t);return{data:e,fromCache:!1,timestamp:new Date}}catch(t){const e=s();if(e)return{data:e.data,fromCache:!0,timestamp:e.timestamp,error:t.message};throw t}}function i(t){return`\n    <div class="securent-fb-cache-notice" role="alert">\n      <svg class="securent-fb-icon-warning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>\n        <line x1="12" y1="9" x2="12" y2="13"></line>\n        <line x1="12" y1="17" x2="12.01" y2="17"></line>\n      </svg>\n      <span>Showing posts from ${function(t){const e=new Date-t,n=Math.floor(e/6e4),s=Math.floor(e/36e5),r=Math.floor(e/864e5);if(n<1)return"just now";if(n<60)return`${n} minute${1!==n?"s":""} ago`;if(s<24)return`${s} hour${1!==s?"s":""} ago`;if(r<7)return`${r} day${1!==r?"s":""} ago`;const i=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=t.getFullYear(),l=String(t.getHours()).padStart(2,"0"),c=String(t.getMinutes()).padStart(2,"0");return`${i}/${a}/${o} ${l}:${c}`}(t)}. Unable to load latest updates.</span>\n    </div>\n  `}class a{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.element=t,this.options={apiUrl:e.apiUrl||"https://securent.nt.gov.au/_design/integration-points/socials/facebook-securent/_nocache",itemsPerPage:parseInt(e.itemsPerPage)||5,fallbackUrl:e.fallbackUrl||"https://www.facebook.com/SecureNT",theme:e.theme||"light",title:e.title||"Latest from SecureNT",content:e.content||null,fallbackMessage:e.fallbackMessage||null},this.filterKeywords=e.filterKeywords?e.filterKeywords.split(";").map(t=>t.trim().toLowerCase()).filter(t=>t):null,this.startDate=e.startDate?new Date(e.startDate):null,this.endDate=e.endDate?new Date(e.endDate):null,this.posts=[],this.currentPage=1,this.isLoading=!1,this.observer=null,this.fromCache=!1,this.cacheTimestamp=null,this.init()}init(){this.element.classList.add("securent-fb-widget"),this.element.classList.add(`securent-fb-theme-${this.options.theme}`),this.setupLazyLoading()}setupLazyLoading(){this.observer=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&!this.isLoading&&0===this.posts.length&&(this.loadFeed(),this.observer.unobserve(this.element))})},{rootMargin:"50px",threshold:.1}),this.observer.observe(this.element)}async loadFeed(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.isLoading){this.isLoading=!0,t?this.showLoadingState():this.showSkeletonLoader();try{const t=await r(this.options.apiUrl);this.posts=this.filterPosts(t.data),this.fromCache=t.fromCache,this.cacheTimestamp=t.timestamp,this.currentPage=1,this.render()}catch(t){this.showError()}finally{this.isLoading=!1}}}showSkeletonLoader(){const t=Array(this.options.itemsPerPage).fill(0).map(()=>'\n      <div class="securent-fb-post securent-fb-skeleton">\n        <div class="securent-fb-skeleton-header"></div>\n        <div class="securent-fb-skeleton-text"></div>\n        <div class="securent-fb-skeleton-text"></div>\n        <div class="securent-fb-skeleton-text short"></div>\n      </div>\n    ').join("");this.element.innerHTML=`<div class="securent-fb-feed">${t}</div>`}showLoadingState(){const t=this.element.querySelector(".securent-fb-loading");t&&(t.style.display="flex")}filterPosts(t){return t&&0!==t.length?t.filter(t=>{if(this.startDate||this.endDate){const e=new Date(t.created_time);if(this.startDate&&e<this.startDate)return!1;if(this.endDate){const t=new Date(this.endDate);if(t.setHours(23,59,59,999),e>t)return!1}}if(this.filterKeywords&&this.filterKeywords.length>0){const e=(t.message||"").toLowerCase();if(!this.filterKeywords.some(t=>e.includes(t)))return!1}return!0}):[]}showError(){const t=s();if(t)this.posts=this.filterPosts(t.data),this.fromCache=!0,this.cacheTimestamp=t.timestamp,this.currentPage=1,this.render();else{const t=this.options.fallbackMessage||"Unable to load posts at this time.";this.element.innerHTML=`\n        <div class="securent-fb-error">\n          <p>${this.escapeHtml(t)}</p>\n          <p><a href="${this.options.fallbackUrl}" target="_blank" rel="noopener noreferrer">Visit SecureNT on Facebook</a></p>\n        </div>\n      `}}render(){const t=(this.currentPage-1)*this.options.itemsPerPage,e=t+this.options.itemsPerPage,n=this.posts.slice(t,e),s=Math.ceil(this.posts.length/this.options.itemsPerPage);let r="";this.fromCache&&(r+=i(this.cacheTimestamp)),r+=this.renderHeader(),r+='<div class="securent-fb-feed">',n.forEach(t=>{r+=this.renderPost(t)}),r+="</div>",s>1&&(r+=this.renderPagination(s)),this.element.innerHTML=r,this.attachEventListeners()}renderHeader(){const t=this.options.content?`<div class="securent-fb-header-content">${this.options.content}</div>`:"";return`\n      <div class="securent-fb-header">\n        <div class="securent-fb-header-top">\n          <h2>${this.escapeHtml(this.options.title)}</h2>\n          <button class="securent-fb-refresh" aria-label="Refresh posts" title="Refresh posts">\n            <svg class="securent-fb-icon-refresh" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <polyline points="23 4 23 10 17 10"></polyline>\n              <polyline points="1 20 1 14 7 14"></polyline>\n              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>\n            </svg>\n            Refresh\n          </button>\n        </div>\n        ${t}\n      </div>\n      <div class="securent-fb-loading" style="display: none;">\n        <div class="securent-fb-spinner"></div>\n        <span>Refreshing...</span>\n      </div>\n    `}renderPost(t){const e=new Date(t.created_time),n=this.getRelativeTime(e),s=this.formatAbsoluteTime(e),r=this.formatMessage(t.message||""),i=t.attachments?this.renderAttachments(t.attachments.data):"";return`\n      <article class="securent-fb-post">\n        <time class="securent-fb-timestamp" datetime="${t.created_time}" title="${s}">\n          ${n}\n        </time>\n        <div class="securent-fb-message">${r}</div>\n        ${i}\n      </article>\n    `}formatMessage(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>")}renderAttachments(t){if(!t||0===t.length)return"";const e=t.map(t=>t.unshimmed_url&&t.title?`\n          <a href="${this.escapeHtml(t.unshimmed_url)}" \n             class="securent-fb-attachment" \n             target="_blank" \n             rel="noopener noreferrer">\n            ${this.escapeHtml(t.title)}\n            <svg class="securent-fb-icon-external" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n              <polyline points="15 3 21 3 21 9"></polyline>\n              <line x1="10" y1="14" x2="21" y2="3"></line>\n            </svg>\n          </a>\n        `:"").filter(t=>t).join("");return e?`<div class="securent-fb-attachments">${e}</div>`:""}renderPagination(t){const e=1===this.currentPage,n=this.currentPage===t;return`\n      <div class="securent-fb-pagination">\n        <button class="securent-fb-btn-pagination securent-fb-btn-prev" \n                ${e?"disabled":""} \n                aria-label="Previous page">\n          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="15 18 9 12 15 6"></polyline>\n          </svg>\n          Previous\n        </button>\n        <span class="securent-fb-page-info" aria-live="polite">\n          Page ${this.currentPage} of ${t}\n        </span>\n        <button class="securent-fb-btn-pagination securent-fb-btn-next" \n                ${n?"disabled":""} \n                aria-label="Next page">\n          Next\n          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <polyline points="9 18 15 12 9 6"></polyline>\n          </svg>\n        </button>\n      </div>\n    `}getRelativeTime(t){const e=new Date-t,n=Math.floor(e/6e4),s=Math.floor(e/36e5),r=Math.floor(e/864e5);return n<1?"just now":n<60?`${n} minute${1!==n?"s":""} ago`:s<24?`${s} hour${1!==s?"s":""} ago`:r<7?`${r} day${1!==r?"s":""} ago`:this.formatShortDate(t)}formatAbsoluteTime(t){return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${t.getFullYear()} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}formatShortDate(t){return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${t.getFullYear()}`}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}attachEventListeners(){const t=this.element.querySelector(".securent-fb-refresh");t&&t.addEventListener("click",()=>this.loadFeed(!0));const e=this.element.querySelector(".securent-fb-btn-prev"),n=this.element.querySelector(".securent-fb-btn-next");e&&e.addEventListener("click",()=>this.goToPage(this.currentPage-1)),n&&n.addEventListener("click",()=>this.goToPage(this.currentPage+1))}goToPage(t){const e=Math.ceil(this.posts.length/this.options.itemsPerPage);t<1||t>e||(this.currentPage=t,this.render(),this.element.scrollIntoView({behavior:"smooth",block:"start"}))}destroy(){this.observer&&this.observer.disconnect(),this.element.innerHTML=""}}!function(t){function e(){document.querySelectorAll("[data-securent-fb-widget]").forEach(t=>{if(t.hasAttribute("data-securent-fb-initialized"))return;const e={apiUrl:t.getAttribute("data-api-url"),itemsPerPage:t.getAttribute("data-items-per-page"),fallbackUrl:t.getAttribute("data-fallback-url"),theme:t.getAttribute("data-theme"),title:t.getAttribute("data-title"),content:t.getAttribute("data-content"),filterKeywords:t.getAttribute("data-filter-keywords"),startDate:t.getAttribute("data-start-date"),endDate:t.getAttribute("data-end-date"),fallbackMessage:t.getAttribute("data-fallback-message")};Object.keys(e).forEach(t=>{null!==e[t]&&void 0!==e[t]||delete e[t]});const n=new a(t,e);t.setAttribute("data-securent-fb-initialized","true"),t._securentFbWidget=n})}const n={init:e,create:function(t){return new a(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})},getInstance:function(t){return t._securentFbWidget||null},version:"1.0.0"};t.SecureNTFacebookWidget=n,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}(window)}();
