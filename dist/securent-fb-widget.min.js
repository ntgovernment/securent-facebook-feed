!function(){"use strict";const e="securent-fb-cache",t="securent-fb-cache-time";function s(s){try{localStorage.setItem(e,JSON.stringify(s)),localStorage.setItem(t,(new Date).toISOString())}catch(e){console.warn("Failed to save to cache:",e)}}function n(){try{const s=localStorage.getItem(e),n=localStorage.getItem(t);if(s&&n)return{data:JSON.parse(s),timestamp:new Date(n)}}catch(e){console.warn("Failed to read from cache:",e)}return null}async function a(e){try{const t=await async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;const n=[1e3,2e3];for(let a=0;a<=t;a++)try{const t=new AbortController,n=setTimeout(()=>t.abort(),5e3),a=await fetch(e,{signal:t.signal,method:"GET",headers:{Accept:"application/json"}});if(clearTimeout(n),!a.ok){if(a.status>=400&&a.status<500)throw new Error(`API error: ${a.status}`);throw new Error(`HTTP ${a.status}`)}const r=await a.json();return s(r),r}catch(e){if(a===t)throw console.error("API fetch failed after retries:",e),e;a<n.length&&await new Promise(e=>setTimeout(e,n[a]))}}(e);return{data:t,fromCache:!1,timestamp:new Date}}catch(e){const t=n();if(t)return{data:t.data,fromCache:!0,timestamp:t.timestamp,error:e.message};throw e}}function r(e){return`\n    <div class="securent-fb-cache-notice" role="alert">\n      <svg class="securent-fb-icon-warning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>\n        <line x1="12" y1="9" x2="12" y2="13"></line>\n        <line x1="12" y1="17" x2="12.01" y2="17"></line>\n      </svg>\n      <span>Showing posts from ${function(e){const t=new Date-e,s=Math.floor(t/6e4),n=Math.floor(t/36e5),a=Math.floor(t/864e5);if(s<1)return"just now";if(s<60)return`${s} minute${1!==s?"s":""} ago`;if(n<24)return`${n} hour${1!==n?"s":""} ago`;if(a<7)return`${a} day${1!==a?"s":""} ago`;const r=String(e.getDate()).padStart(2,"0"),i=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear(),l=String(e.getHours()).padStart(2,"0"),c=String(e.getMinutes()).padStart(2,"0");return`${r}/${i}/${o} ${l}:${c}`}(e)}. Unable to load latest updates.</span>\n    </div>\n  `}class i{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.element=e,this.options={apiUrl:t.apiUrl||"https://securent.nt.gov.au/_design/integration-points/socials/facebook-securent/_nocache",itemsPerPage:parseInt(t.itemsPerPage)||5,fallbackUrl:t.fallbackUrl||"https://www.facebook.com/SecureNT",theme:t.theme||"light",title:t.title||"Latest from SecureNT",content:t.content||null,fallbackMessage:t.fallbackMessage||null,cardSize:t.cardSize||"full"},this.filterKeywords=t.filterKeywords?t.filterKeywords.split(";").map(e=>e.trim().toLowerCase()).filter(e=>e):null;const s=new Date("1970-01-01"),n=new Date(Date.now()+864e5);this.startDate=t.startDate?new Date(t.startDate):s,this.endDate=t.endDate?new Date(t.endDate):n,isNaN(this.startDate.getTime())&&(console.warn("Invalid start date provided, using default (1970-01-01)"),this.startDate=s),isNaN(this.endDate.getTime())&&(console.warn("Invalid end date provided, using default (tomorrow)"),this.endDate=n),this.posts=[],this.currentPage=1,this.isLoading=!1,this.observer=null,this.fromCache=!1,this.cacheTimestamp=null,this.lastUpdated=null,this.init()}init(){this.element.classList.add("securent-fb-widget"),this.element.classList.add(`securent-fb-theme-${this.options.theme}`),this.setupLazyLoading()}setupLazyLoading(){this.observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&!this.isLoading&&0===this.posts.length&&(this.loadFeed(),this.observer.unobserve(this.element))})},{rootMargin:"50px",threshold:.1}),this.observer.observe(this.element)}async loadFeed(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.isLoading){this.isLoading=!0,e?this.showLoadingState():this.showSkeletonLoader();try{const e=await a(this.buildApiUrl());this.posts=this.filterPosts(e.data),this.fromCache=e.fromCache,this.cacheTimestamp=e.timestamp,this.lastUpdated=new Date,this.currentPage=1,this.render()}catch(e){this.showError()}finally{this.isLoading=!1}}}showSkeletonLoader(){const e=Array(this.options.itemsPerPage).fill(0).map(()=>'\n      <div class="securent-fb-post securent-fb-skeleton">\n        <div class="securent-fb-skeleton-header"></div>\n        <div class="securent-fb-skeleton-text"></div>\n        <div class="securent-fb-skeleton-text"></div>\n        <div class="securent-fb-skeleton-text short"></div>\n      </div>\n    ').join("");this.element.innerHTML=`<div class="securent-fb-feed">${e}</div>`}showLoadingState(){const e=this.element.querySelector(".securent-fb-loading");e&&(e.style.display="flex")}filterPosts(e){return e&&0!==e.length?e.filter(e=>{if(this.filterKeywords&&this.filterKeywords.length>0){const t=(e.message||"").toLowerCase();if(!this.filterKeywords.some(e=>t.includes(e)))return!1}return!0}):[]}formatDateForApi(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}buildApiUrl(){const e=this.options.apiUrl,t=e.includes("?")?"&":"?";return`${e}${t}since=${encodeURIComponent(this.formatDateForApi(this.startDate))}&until=${encodeURIComponent(this.formatDateForApi(this.endDate))}&limit=100`}showError(){const e=n();if(e)this.posts=this.filterPosts(e.data),this.fromCache=!0,this.cacheTimestamp=e.timestamp,this.currentPage=1,this.render();else{const e=this.options.fallbackMessage||"Unable to load posts at this time.";this.element.innerHTML=`\n        <div class="securent-fb-error">\n          <p>${this.escapeHtml(e)}</p>\n          <p><a href="${this.options.fallbackUrl}" target="_blank" rel="noopener noreferrer">Visit SecureNT on Facebook</a></p>\n        </div>\n      `}}render(){const e=(this.currentPage-1)*this.options.itemsPerPage,t=e+this.options.itemsPerPage,s=this.posts.slice(e,t),n=Math.ceil(this.posts.length/this.options.itemsPerPage);let a="";this.fromCache&&(a+=r(this.cacheTimestamp)),a+=this.renderHeader(),a+='<div class="securent-fb-feed">',s.forEach(e=>{a+=this.renderPost(e)}),a+="</div>",n>1&&(a+=this.renderPagination(n)),this.element.innerHTML=a,this.attachEventListeners(),this.applyCompactCardLogic()}renderHeader(){const e=this.options.content?`<div class="securent-fb-header-content">${this.options.content}</div>`:"",t=this.lastUpdated?`<div class="securent-fb-last-updated">Last updated: ${this.formatAbsoluteTime(this.lastUpdated)}</div>`:"";return`\n      <div class="securent-fb-header">\n        <div class="securent-fb-header-top">\n          <h2>${this.escapeHtml(this.options.title)}</h2>\n          <button class="securent-fb-refresh" aria-label="Refresh posts" title="Refresh posts">\n            <svg class="securent-fb-icon-refresh" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <polyline points="23 4 23 10 17 10"></polyline>\n              <polyline points="1 20 1 14 7 14"></polyline>\n              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>\n            </svg>\n            Refresh\n          </button>\n        </div>\n        ${t}\n        ${e}\n      </div>\n      <div class="securent-fb-loading" style="display: none;">\n        <div class="securent-fb-spinner"></div>\n        <span>Refreshing...</span>\n      </div>\n    `}renderPost(e){const t=new Date(e.created_time),s=this.getRelativeTime(t),n=this.formatAbsoluteTime(t),a=this.formatMessage(e.message||""),r=e.attachments?this.renderAttachments(e.attachments.data):"";return`\n      <article class="securent-fb-post${"compact"===this.options.cardSize?" securent-fb-post-compact":""}">\n        <time class="securent-fb-timestamp" datetime="${e.created_time}" title="${n}">\n          ${s}\n        </time>\n        <div class="securent-fb-message">${a}</div>\n        ${r}\n      </article>\n    `}formatMessage(e){let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");t=t.replace(/(https?:\/\/[^\s<]+)/g,e=>`<a href="${e}" target="_blank" rel="noopener noreferrer" class="securent-fb-link">${e}</a>`);return t=t.replace(/(^|[^\/])(www\.[^\s<]+)/g,(e,t,s)=>`${t}<a href="https://${s}" target="_blank" rel="noopener noreferrer" class="securent-fb-link">${s}</a>`),t=t.replace(/\n/g,"<br>"),t}renderAttachments(e){if(!e||0===e.length)return"";const t=e.map(e=>e.unshimmed_url&&e.title?`\n          <a href="${this.escapeHtml(e.unshimmed_url)}" \n             class="securent-fb-attachment" \n             target="_blank" \n             rel="noopener noreferrer">\n            ${this.escapeHtml(e.title)}\n            <svg class="securent-fb-icon-external" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>\n              <polyline points="15 3 21 3 21 9"></polyline>\n              <line x1="10" y1="14" x2="21" y2="3"></line>\n            </svg>\n          </a>\n        `:"").filter(e=>e).join("");return t?`<div class="securent-fb-attachments">${t}</div>`:""}renderPagination(e){const t=1===this.currentPage,s=this.currentPage===e;let n="";let a=Math.max(1,this.currentPage-Math.floor(2.5)),r=Math.min(e,a+5-1);r-a<4&&(a=Math.max(1,r-5+1));for(let e=a;e<=r;e++){n+=`<li class="page-item ${e===this.currentPage?"active":""}"><a class="page-link" href="javascript:void(0)" data-page="${e}">${e}</a></li>`}return`\n      <nav aria-label="navigation" class="pb-5 mb-15">\n        <ul class="pagination justify-content-center">\n          <li class="page-item ${t?"disabled":""}">\n            <a class="page-link securent-fb-btn-prev" href="javascript:void(0)" tabindex="${t?"-1":""}" aria-disabled="${t}">Previous</a>\n          </li>\n          ${n}\n          <li class="page-item ${s?"disabled":""}">\n            <a class="page-link securent-fb-btn-next" href="javascript:void(0)" tabindex="${s?"-1":""}" aria-disabled="${s}">Next</a>\n          </li>\n        </ul>\n      </nav>\n    `}getRelativeTime(e){const t=new Date-e,s=Math.floor(t/6e4),n=Math.floor(t/36e5),a=Math.floor(t/864e5);return s<1?"just now":s<60?`${s} minute${1!==s?"s":""} ago`:n<24?`${n} hour${1!==n?"s":""} ago`:a<7?`${a} day${1!==a?"s":""} ago`:this.formatShortDate(e)}formatAbsoluteTime(e){return`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}/${e.getFullYear()} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}formatShortDate(e){return`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}/${e.getFullYear()}`}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}attachEventListeners(){const e=this.element.querySelector(".securent-fb-refresh");e&&e.addEventListener("click",()=>this.loadFeed(!0));const t=this.element.querySelector(".securent-fb-btn-prev"),s=this.element.querySelector(".securent-fb-btn-next"),n=this.element.querySelectorAll(".page-link[data-page]");t&&t.addEventListener("click",()=>this.goToPage(this.currentPage-1)),s&&s.addEventListener("click",()=>this.goToPage(this.currentPage+1)),n.forEach(e=>{e.addEventListener("click",e=>{const t=parseInt(e.target.getAttribute("data-page"));this.goToPage(t)})})}applyCompactCardLogic(){if("compact"!==this.options.cardSize)return;this.element.querySelectorAll(".securent-fb-post-compact").forEach(e=>{const t=e.style.maxHeight;e.style.maxHeight="none";const s=e.scrollHeight;if(e.style.maxHeight=t,s>300){e.classList.add("securent-fb-post-has-more");const t=document.createElement("a");t.href="#",t.className="securent-fb-see-more",t.textContent="See more",t.addEventListener("click",s=>{s.preventDefault(),e.classList.toggle("securent-fb-post-expanded"),t.textContent=e.classList.contains("securent-fb-post-expanded")?"See less":"See more"}),e.appendChild(t)}else e.classList.remove("securent-fb-post-compact")})}goToPage(e){const t=Math.ceil(this.posts.length/this.options.itemsPerPage);e<1||e>t||(this.currentPage=e,this.render(),this.element.scrollIntoView({behavior:"smooth",block:"start"}))}destroy(){this.observer&&this.observer.disconnect(),this.element.innerHTML=""}}!function(e){function t(){document.querySelectorAll("[data-securent-fb-widget]").forEach(e=>{if(e.hasAttribute("data-securent-fb-initialized"))return;const t={apiUrl:e.getAttribute("data-api-url"),itemsPerPage:e.getAttribute("data-items-per-page"),fallbackUrl:e.getAttribute("data-fallback-url"),theme:e.getAttribute("data-theme"),title:e.getAttribute("data-title"),content:e.getAttribute("data-content"),filterKeywords:e.getAttribute("data-filter-keywords"),startDate:e.getAttribute("data-start-date"),endDate:e.getAttribute("data-end-date"),fallbackMessage:e.getAttribute("data-fallback-message"),cardSize:e.getAttribute("data-card-size")};Object.keys(t).forEach(e=>{null!==t[e]&&void 0!==t[e]&&""!==t[e]||delete t[e]});const s=new i(e,t);e.setAttribute("data-securent-fb-initialized","true"),e._securentFbWidget=s})}const s={init:t,create:function(e){return new i(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})},getInstance:function(e){return e._securentFbWidget||null},version:"1.0.0"};e.SecureNTFacebookWidget=s,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}(window)}();
